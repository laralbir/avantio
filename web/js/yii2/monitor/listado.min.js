var startDateRange=null;var endDateRange=null;$(document).ready(initListado);function initListado(){initDateRangerPicker();getListado();$("#seleccionar-todo-listado").click(function(){$(".check-listado").prop("checked",$("#seleccionar-todo-listado").prop("checked"))});$("#btn-listado-marcar-visto").click(setVisto);$("#btn-cargar-listado").click(getListado);$("#select-visto").change(getListado);$("#select-nivel").change(getListado)}function getListado(){$("#tabla-log > tbody").html('<tr><td class="text-center" colspan="6"><div class="loader"></div><div class="mt-2">Cargando listado</div></tr>');var a={id:id_monitor,visto:parseInt($("#select-visto").val()),nivel:parseInt($("#select-nivel").val()),startDateRange:startDateRange,endDateRange:endDateRange};$.get(baseURL+"/monitor/listado/get-listado",a,null,"json").done(function(b){if(!b.error){$("#tabla-log > tbody").empty();for(i=0;i<b.listado.length;i++){var d="";switch(parseInt(b.listado[i]["nivel"])){case 1:d="table-danger";break;case 4:d="table-warning";break}var c=(parseInt(b.listado[i]["visto"])===0)?"font-weight-bold":"";$("#tabla-log > tbody").append('                            <tr class="'+d+" "+c+'" row-data-id-linea="'+b.listado[i]["id"]+'">\n                                <td class="text-center"><input class="check-listado" type="checkbox" data-id-linea="'+b.listado[i]["id"]+'"></td>\n                                <td>'+b.listado[i]["fecha"]+'</td>\n                                <td class="text-center">'+b.listado[i]["nivel"]+"</td>\n                                <td>"+b.listado[i]["categoria"]+'</td>\n                                <td><div class="listado-ip">'+b.listado[i]["ip"]+'</div></td>\n                                <td><div class="listado-mensaje">'+b.listado[i]["mensaje"]+"</div></td>\n                            </tr>")}$(".check-listado").click(function(f){f.stopPropagation()});$("#tabla-log > tbody > tr").unbind("click");$("#tabla-log > tbody > tr").click(function(){window.location.href=baseURL+"/monitor/detalle/index?id="+id_monitor+"&d="+$(this).attr("row-data-id-linea")})}}).always(function(b){}).fail(function(b){$("#tabla-log > tbody").html('<tr><td class="text-center" colspan="6"><span class="badge badge-danger mr-2">¡FALLO!</span></tr>')})}function setVisto(){var c=$(".check-listado:checked").get();var a=new Array();if(c.length>0){for(i=0;i<c.length;i++){a.push(parseInt($(c[i]).attr("data-id-linea")));var d=$("[row-data-id-linea="+$(c[i]).attr("data-id-linea")+"]").get();$(d).find("td:nth-child(1)").html('<div class="loader-visto loader-xs" style="display: block;"></div>')}var b={id:id_monitor,seleccionados:a};$.post(baseURL+"/monitor/listado/set-visto",b,null,"json").done(function(e){if(!e.error){for(i=0;i<e.ids.length;i++){var f=$("[row-data-id-linea="+e.ids[i]+"]").get();$(f).find("td:nth-child(1)").html('<input class="check-listado" type="checkbox" data-id-linea="'+e.ids[i]+'">');if(parseInt(parseInt($("[name=inlineRadioOptions]:checked").val()))===1){$(f).remove()}else{$(f).removeClass("font-weight-bold")}}$(".check-listado").click(function(g){g.stopPropagation()})}}).always(function(e){$(".loader-visto").remove();$(".check-listado").prop("checked",false);$("#seleccionar-todo-listado").prop("checked",false)}).fail(function(e){})}}function initDateRangerPicker(){moment.locale("es");var c=moment().subtract(6,"days");var b=moment();b.set({hour:23,minute:59,second:59});startDateRange=c.unix();endDateRange=b.unix();function a(e,d){$("#datarange-listado span").html(e.format("D MMMM YYYY")+" - "+d.format("D MMMM YYYY"))}$("#datarange-listado").daterangepicker({startDate:c,endDate:b,opens:"left",locale:locale_daterangepicker_es,ranges:{Hoy:[moment(),moment()],Ayer:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Últimos 7 días":[moment().subtract(6,"days"),moment()],"Últimos 30 días":[moment().subtract(29,"days"),moment()],"Éste mes":[moment().startOf("month"),moment().endOf("month")],"Mes pasado":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]}},a);a(c,b);$("#datarange-listado").on("apply.daterangepicker",function(g,f){startDateRange=f.startDate.unix();var d=f.endDate;d.set({hour:23,minute:59,second:59});endDateRange=d.unix();getListado()})};